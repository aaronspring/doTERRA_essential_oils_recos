# AGENTS.md

## Project Overview

This project is a doTERRA essential oils recommendation and search system. It uses:
- **Backend**: FastAPI with Qdrant vector database for semantic search
- **ML Stack**: Sentence-Transformers for embeddings
- **Data Processing**: BeautifulSoup, lxml for scraping; Pandas for analysis
- **Package Management**: uv

---

## General Principles

### Code Quality Standards
- Write self-documenting code with clear function/variable names
- Keep functions focused and small (single responsibility principle)
- Use type hints for all function parameters and return values
- Handle errors explicitly with meaningful error messages
- Log important operations and errors appropriately

### AI Assistant Behavior
- Always confirm understanding before implementing significant changes
- Ask for clarification on ambiguous requirements
- Propose solutions rather than making assumptions
- Point out potential issues or edge cases in proposed solutions
- Suggest improvements without being pedantic

---

## Python Development

### Environment Management
- Use `.venv` generated by `uv` for all dependencies
- Install packages: `uv add <package>`
- Install dev dependencies: `uv add --dev <package>`
- Run Python scripts: `uv run python <script>`
- Run scripts with dependencies: `uv run python script.py`
- Update all packages: `uv sync`

### Code Style
- Follow PEP 8 guidelines
- Use Black for formatting: `uv run black <files>`
- Use Ruff for linting: `uv run ruff check <files>`
- Maximum line length: 100 characters
- Use relative imports within the project
- One import per line, grouped: standard library, third-party, local

### Type Hints
```python
from typing import List, Optional, Dict, Any

def process_oils(oils: List[Dict[str, Any]], threshold: float = 0.5) -> List[Dict[str, Any]]:
    """Process essential oils and return filtered results."""
    ...
```

### Documentation
- Use docstrings for all public functions and classes
- Follow Google docstring format
- Include type information in docstrings
- Update README.md for user-facing changes
- Add inline comments for complex logic

---

## Git Workflow

### Commit Conventions
- Use conventional commits: `type(scope): description`
- Types: `feat`, `fix`, `docs`, `style`, `refactor`, `test`, `chore`
- Keep commits atomic and focused
- Write meaningful commit messages

### Branching
- Main branch: `main` (production-ready code)
- Feature branches: `feature/<description>`
- Bug fix branches: `fix/<description>`
- Never commit directly to main

### Never
- `git add .` (always stage specific files)
- `git commit --amend` after push
- `git push --force`
- Commit secrets, credentials, or `.env` files

### Before Committing
1. Run linting: `uv run ruff check .`
2. Run tests: `uv run pytest` (if tests exist)
3. Review changes: `git diff --staged`
4. Verify no secrets: `git status`

---

## API Development (FastAPI)

### Endpoint Design
- Use descriptive route names: `/api/v1/oils`, `/api/v1/recommendations`
- Follow REST conventions
- Use appropriate HTTP methods (GET, POST, PUT, DELETE)
- Version APIs: `/api/v1/`

### Request/Response Models
```python
from pydantic import BaseModel, Field

class OilSearchRequest(BaseModel):
    query: str = Field(..., min_length=1, max_length=500)
    top_k: int = Field(default=10, ge=1, le=100)
    filters: Optional[Dict[str, Any]] = None

class OilRecommendation(BaseModel):
    oil_id: str
    name: str
    description: str
    score: float
```

### Error Handling
- Use FastAPI's HTTPException for API errors
- Create custom exception handlers
- Return consistent error responses
- Log errors with context

---

## Security

### Secrets Management
- Use environment variables for all secrets
- Store secrets in `.env` file (never commit)
- Access via `os.getenv()` or `config.py`
- Use `.env.example` as template

### Best Practices
- Never log secrets or API keys
- Validate all inputs from external sources
- Sanitize user-provided data
- Use HTTPS in production
- Implement rate limiting on public endpoints

---

## Project Structure

```
doTERRA_essential_oils_recos/
├── backend/              # FastAPI application
│   └── main.py          # Entry point
├── processing/          # Data processing scripts
│   ├── scrape_single.py
│   ├── scrape_all.py
│   ├── serialize.py
│   └── ingest_to_qdrant.py
├── config.py           # Configuration and secrets
├── pyproject.toml      # Project metadata and dependencies
├── AGENTS.md           # This file
├── README.md           # User documentation
└── data/               # Processed data (not in git)
```

---

## Tool Usage

### Playwright MCP
- Use for testing web interactions
- Navigate to URLs, fill forms, click elements
- Take snapshots for debugging
- Handle dialogs and alerts

### Development Tools
```bash
# Start FastAPI dev server
uv run uvicorn backend.main:app --reload

# Format code
uv run black .

# Lint code
uv run ruff check .

# Install pre-commit hooks
uv run pre-commit install
```

---

## Performance

### General Guidelines
- Use batch operations for database/vector operations
- Cache expensive computations
- Use async/await for I/O operations
- Profile before optimizing

### Vector Operations
- Batch embedding generation
- Use appropriate quantization
- Index optimization for large collections

---

## Documentation

### When to Update README.md and AGENTS.md
- New features or capabilities
- Changed API endpoints
- New configuration options
- Updated installation instructions
- New command-line options

### README Structure
- Project description
- Quick start guide
- Installation
- Usage examples
- API documentation
- Configuration options

---

## Code Review Checklist

- [ ] Code follows project conventions
- [ ] Type hints are correct and complete
- [ ] Error handling is appropriate
- [ ] No hardcoded values (use config)
- [ ] No secrets in code
- [ ] Documentation updated
- [ ] Linting passes
- [ ] Variables are named descriptively
- [ ] Functions are focused and testable
